name: Build and Deploy CloudStream Plugins

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - run: chmod +x ./gradlew

      - name: Detect makePluginsJson task
        id: detect
        run: |
          TASK=$(./gradlew tasks --all | grep makePluginsJson | awk '{print $1}' | head -n 1)
          if [ -z "$TASK" ]; then
            echo "No makePluginsJson task found"
            exit 1
          fi
          echo "task=$TASK" >> $GITHUB_OUTPUT

      - name: Build plugins
        run: |
          ./gradlew build ${{ steps.detect.outputs.task }} --no-daemon --stacktrace

      - name: Upload plugin artifacts
        uses: actions/upload-artifact@v4
        with:
          name: plugins
          path: |
            **/*.cs3
            **/plugins.json
          if-no-files-found: error

  deploy-builds-branch:
    needs: build
    runs-on: ubuntu-24.04

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/download-artifact@v4
        with:
          name: plugins
          path: temp_artifacts

      - name: Push to Builds branch
        run: |
          git fetch origin Builds || true
          git checkout Builds || git checkout -b Builds
          git pull origin Builds || true

          rm -f *.cs3 plugins.json
          cp -r temp_artifacts/* .

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          if git diff --cached --quiet; then
            exit 0
          fi

          git commit -m "Update plugin builds"
          git push origin Builds
