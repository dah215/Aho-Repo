name: Build & Deploy Plugins

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

env:
  JAVA_VERSION: 17
  ARTIFACT_NAME: plugins
  ARTIFACT_DIR: temp_artifacts

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Gradle build
        run: |
          ./gradlew build --no-daemon --stacktrace

      - name: List produced artifact files (debug)
        run: |
          echo "=== files matching .cs3 or plugins.json in workspace ==="
          find . -type f \( -name "*.cs3" -o -name "plugins.json" \) -print -exec ls -l {} \; || true

      - name: Check artifacts presence (set output)
        id: check_artifacts
        run: |
          FOUND=$(find . -type f \( -name "*.cs3" -o -name "plugins.json" \) -print | head -n 1 || true)
          if [ -z "$FOUND" ]; then
            echo "HAS_ARTIFACTS=false" >> $GITHUB_OUTPUT
          else
            echo "HAS_ARTIFACTS=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload plugin artifacts (only if present)
        if: steps.check_artifacts.outputs.HAS_ARTIFACTS == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/*.cs3
            **/plugins.json
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plugin artifacts (if any)
        id: download
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_DIR }}
        continue-on-error: true

      - name: Show downloaded artifacts (debug)
        run: |
          echo "=== contents of ${{ env.ARTIFACT_DIR }} ==="
          ls -la ${{ env.ARTIFACT_DIR }} || true
          find ${{ env.ARTIFACT_DIR }} -type f -print -exec ls -l {} \; || true

      - name: Check downloaded artifacts (set output)
        id: check_download
        run: |
          if [ -d "${{ env.ARTIFACT_DIR }}" ] && [ -n "$(ls -A ${{ env.ARTIFACT_DIR }} 2>/dev/null)" ]; then
            echo "NO_ARTIFACTS=false" >> $GITHUB_OUTPUT
          else
            echo "NO_ARTIFACTS=true" >> $GITHUB_OUTPUT
          fi

      - name: Exit if no artifacts
        if: steps.check_download.outputs.NO_ARTIFACTS == 'true'
        run: |
          echo "No artifacts to deploy; skipping deploy steps."
          exit 0

      - name: Prepare Builds branch
        run: |
          git fetch origin Builds || true
          git checkout Builds || git checkout -b Builds
          git pull origin Builds || true

      - name: Copy artifacts into repo root
        run: |
          rm -f *.cs3 plugins.json || true
          mkdir -p tmp_deploy
          cp -r ${{ env.ARTIFACT_DIR }}/* tmp_deploy/ || true
          cp -r tmp_deploy/* .
          echo "=== after copy: list .cs3 and plugins.json ==="
          find . -maxdepth 3 -type f \( -name "*.cs3" -o -name "plugins.json" \) -print -exec ls -l {} \; || true

      - name: Ensure artifacts are staged (force if ignored)
        run: |
          # Force-add .cs3 if ignored by .gitignore
          IGNORED_CS3=$(git ls-files --others --exclude-standard | grep '\.cs3$' || true)
          if [ -n "$IGNORED_CS3" ]; then
            git add -f $IGNORED_CS3 || true
          fi
          git add -A
          echo "=== staged files ==="
          git status --porcelain

      - name: Commit & push to Builds
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto update plugin builds: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          git push origin Builds --force-with-lease
