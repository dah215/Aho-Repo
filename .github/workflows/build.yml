name: Build & Deploy Plugins (robust debug)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  JAVA_VERSION: 17
  ARTIFACT_NAME: plugins
  ARTIFACT_DIR: temp_artifacts

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Gradle build (prints outputs)
        run: |
          ./gradlew build --no-daemon --stacktrace || true

      - name: List produced artifact files (debug)
        run: |
          echo "===== workspace files matching .cs3 / plugins.json ====="
          find . -type f \( -name "*.cs3" -o -name "plugins.json" \) -print -exec ls -l {} \; || true

      - name: Upload plugin artifacts (only if present)
        if: ${{ !contains(steps['build'].outcome, 'failure') && (hashFiles('**/*.cs3') != '' || hashFiles('**/plugins.json') != '') }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: |
            **/*.cs3
            **/plugins.json
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plugin artifacts (if any)
        id: download
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
          path: ${{ env.ARTIFACT_DIR }}
        continue-on-error: true

      - name: Debug: list downloaded artifacts
        run: |
          echo "===== temp_artifacts listing ====="
          ls -la ${{ env.ARTIFACT_DIR }} || true
          find ${{ env.ARTIFACT_DIR }} -type f -print -exec ls -l {} \; || true

      - name: Check artifacts presence
        id: check
        run: |
          if [ ! -d "${{ env.ARTIFACT_DIR }}" ] || [ -z "$(ls -A ${{ env.ARTIFACT_DIR }} 2>/dev/null)" ]; then
            echo "NO_ARTIFACTS=true" >> $GITHUB_OUTPUT
          else
            echo "NO_ARTIFACTS=false" >> $GITHUB_OUTPUT
          fi

      - name: Exit early if no artifacts
        if: steps.check.outputs.NO_ARTIFACTS == 'true'
        run: |
          echo "No artifacts to deploy. Skipping push."
          exit 0

      - name: Prepare Builds branch
        run: |
          git fetch origin Builds || true
          git checkout Builds || git checkout -b Builds
          git pull origin Builds || true

      - name: Copy artifacts into repo root
        run: |
          rm -f *.cs3 plugins.json || true
          mkdir -p tmp_deploy
          cp -r ${{ env.ARTIFACT_DIR }}/* tmp_deploy/ || true
          echo "After copy, listing tmp_deploy:"
          ls -la tmp_deploy || true
          find tmp_deploy -type f -print -exec ls -l {} \; || true
          # Move to repo root
          cp -r tmp_deploy/* . || true
          echo "After move to repo root, listing .cs3 and plugins.json"
          find . -maxdepth 3 -type f \( -name "*.cs3" -o -name "plugins.json" \) -print -exec ls -l {} \; || true

      - name: Ensure files are added (force if ignored)
        run: |
          # Show gitignore-ignored .cs3
          git status --porcelain --ignored
          IGNORED=$(git status --porcelain --ignored | awk '/\\.cs3/ {print $2}' | tr '\n' ' ')
          if [ -n "$IGNORED" ]; then
            echo "Force-adding ignored .cs3 files: $IGNORED"
            git add -f $IGNORED || true
          fi
          # Add any other artifacts
          git add -A
          echo "Staged files:"
          git status --porcelain

      - name: Commit & show commit content
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "Auto update plugin builds: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "Commit created:"
          git --no-pager show --name-only --pretty=format:"%h %s" HEAD

      - name: Push to Builds branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # push; use force-with-lease to be safer
          git push origin Builds --force-with-lease
