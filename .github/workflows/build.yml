name: Build and Push Plugins (debug-verbose)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  JAVA_VERSION: 17
  BUILD_BRANCH: Builds

jobs:
  build-and-push:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout full
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Run Gradle build
        run: ./gradlew build --no-daemon --stacktrace

      - name: Generate plugins.json and repository.json
        run: ./gradlew makePluginsJson makeRepositoryJson --no-daemon --stacktrace || true

      - name: List all build artifacts (debug)
        run: |
          echo "=== All .cs3 files ==="
          find . -type f -name "*.cs3" -ls || true
          echo ""
          echo "=== All .json files in build dirs ==="
          find . -type f -path "*/build/*.json" -ls || true
          echo ""
          echo "=== Complete build/ directory structure ==="
          find . -path "*/build/*" -type f -ls || true

      - name: Collect artifacts to staging directory
        run: |
          mkdir -p staging
          
          # Copy all .cs3 files
          echo "=== Copying .cs3 files ==="
          find . -type f -name "*.cs3" -exec cp -v {} staging/ \; || true
          
          # Copy plugins.json and repository.json from root build dir
          echo "=== Copying JSON files ==="
          if [ -f "build/plugins.json" ]; then
            cp -v build/plugins.json staging/
          fi
          if [ -f "build/repository.json" ]; then
            cp -v build/repository.json staging/
          fi
          
          # Also check in subproject build dirs
          find . -type f -name "plugins.json" -exec cp -v {} staging/ \; || true
          find . -type f -name "repository.json" -exec cp -v {} staging/ \; || true
          
          echo "=== Staging directory contents ==="
          ls -lah staging/ || true

      - name: Check if artifacts exist
        id: check
        run: |
          if [ -n "$(ls -A staging/ 2>/dev/null)" ]; then
            echo "HAS_ARTIFACTS=true" >> $GITHUB_OUTPUT
            echo "Found artifacts to push"
          else
            echo "HAS_ARTIFACTS=false" >> $GITHUB_OUTPUT
            echo "No artifacts found"
          fi

      - name: Push to Builds branch
        if: steps.check.outputs.HAS_ARTIFACTS == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BUILD_BRANCH: ${{ env.BUILD_BRANCH }}
        run: |
          set -xe
          
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch or create Builds branch
          git fetch origin $BUILD_BRANCH || true
          if git rev-parse --verify origin/$BUILD_BRANCH >/dev/null 2>&1; then
            git checkout $BUILD_BRANCH
            git reset --hard origin/$BUILD_BRANCH
          else
            git checkout --orphan $BUILD_BRANCH
            git rm -rf . || true
          fi

          # Copy artifacts from staging
          cp -rv staging/* . || true
          
          echo "=== Files in Builds branch ==="
          ls -lah
          
          # Force add all files (in case .cs3 is in .gitignore)
          git add -f *.cs3 *.json || true
          git add -A
          
          git status --porcelain

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Auto update plugin builds: run ${GITHUB_RUN_ID} (${GITHUB_SHA:0:7})"
          
          # Show what we're committing
          git --no-pager show --name-only --stat HEAD

          # Push with verbose output
          export GIT_TRACE=1 GIT_CURL_VERBOSE=1
          remote_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git remote set-url origin "$remote_url"
          git push origin $BUILD_BRANCH --force-with-lease
